
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Senju Lore Search Engine</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            background-color: #0a0a12;
            font-family: Arial, sans-serif;
            color: #ffffff;
            min-height: 100vh;
        }
        header {
            background: linear-gradient(to right, #1c1c2c, #2c2c3c);
            text-align: center;
            padding: 50px 20px 20px;
        }
        header h1 {
            font-size: 42px;
            color: #ffd966;
            margin: 0 0 10px;
        }
        header p {
            font-size: 18px;
            color: #cccccc;
            margin: 0;
        }
        .search-container {
            text-align: center;
            padding: 20px;
        }
        .search-box {
            width: 60%;
            max-width: 500px;
            padding: 12px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            margin: 0 10px 15px 0;
            background-color: #1a1a26;
            color: #ffffff;
        }
        .filter-select {
            padding: 10px;
            font-size: 14px;
            border-radius: 6px;
            border: none;
            background-color: #1a1a26;
            color: #ffffff;
        }
        .results {
            width: 80%;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .result {
            background-color: #1a1a26;
            border-left: 4px solid #ffd966;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
        }
        .result h3 {
            margin: 0;
            color: #ffcc66;
            font-size: 20px;
        }
        .result p {
            margin: 5px 0 0;
            color: #cccccc;
            font-size: 16px;
        }
        .result .character-link {
            font-style: italic;
            color: #ffd966;
            font-size: 14px;
            margin-top: 5px;
        }
        .no-results, .loading {
            text-align: center;
            color: #cccccc;
            font-size: 18px;
        }
        mark {
            background-color: #ffd966;
            color: #0a0a12;
            padding: 0 2px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Senju Lore Search Engine</h1>
        <p>Search the entire Sir Senju multiverse in one place</p>
    </header>
    <div class="search-container">
        <input type="text" id="searchInput" class="search-box" placeholder="Search characters, factions, energies...">
        <select id="filterSelect" class="filter-select">
            <option value="All">All</option>
            <option value="Character">Characters</option>
            <option value="Faction">Factions</option>
            <option value="Race">Races</option>
            <option value="Energy">Energy Types</option>
            <option value="Ability">Abilities</option>
            <option value="Universe">Universes</option>
        </select>
    </div>
    <div class="results" id="resultsContainer">
        <p class="loading">Loading data...</p>
    </div>

    <script src="../js/senju_characters_FULL.js"></script>
    <script src="../js/senju_universes.js"></script>
    <script src="../js/senju_factions.js"></script>
    <script src="../js/senju_energy_types.js"></script>
    <script src="../js/senju_races.js"></script>
    <script>
        let data = [];

        function loadData() {
            // Show loading indicator
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = '<p class="loading">Loading data...</p>';

            // Safely access JS file data, default to empty arrays
            const characters = window.senjuLoreData || [];
            const universes = window.senjuUniverses || [];
            const factions = window.senjuFactions || [];
            const energyTypes = window.senjuEnergyTypes || [];
            const races = window.senjuRaces || [];

            // Merge JS data
            data = [
                ...characters.map(item => ({ name: item.name || 'Unknown', type: 'Character', desc: item.desc || 'No description' })),
                ...universes.map(item => ({ name: item.name || 'Unknown', type: 'Universe', desc: item.desc || 'No description' })),
                ...factions.map(item => ({ name: item.name || 'Unknown', type: 'Faction', desc: item.desc || 'No description' })),
                ...energyTypes.map(item => ({ name: item.name || 'Unknown', type: 'Energy', desc: item.desc || 'No description' })),
                ...races.map(item => ({ name: item.name || 'Unknown', type: 'Race', desc: item.desc || 'No description' }))
            ];

            // Render initial results
            renderResults();

            // Fetch and merge JSON abilities
            fetch('../js/full_senju_character_abilities.json')
                .then(response => {
                    if (!response.ok) throw new Error(`Failed to load abilities: ${response.status}`);
                    return response.json();
                })
                .then(abilities => {
                    // Flatten abilities, include character name for linking
                    const formattedAbilities = Object.keys(abilities).flatMap(character => 
                        abilities[character].map(ability => ({
                            name: ability.name || 'Unknown',
                            type: 'Ability',
                            desc: ability.description || 'No description available',
                            character: character // Store character name for linking
                        }))
                    );
                    data = [...data, ...formattedAbilities];
                    renderResults();
                })
                .catch(error => {
                    console.error('Error loading abilities:', error);
                    renderResults(); // Render with available data
                });
        }

        // Get DOM elements
        const searchInput = document.getElementById('searchInput');
        const filterSelect = document.getElementById('filterSelect');
        const resultsContainer = document.getElementById('resultsContainer');

        // Escape HTML to prevent XSS
        function escapeHTML(str) {
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        // Highlight search terms in text
        function highlightSearchTerm(text, query) {
            if (!query) return escapeHTML(text);
            const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return escapeHTML(text).replace(regex, '<mark>$1</mark>');
        }

        // Render filtered and sorted results
        function renderResults() {
            const query = (searchInput.value || '').toLowerCase().trim();
            const filter = filterSelect.value;

            // Filter data
            const filteredData = data.filter(item => {
                const name = (item.name || '').toLowerCase();
                const desc = (item.desc || '').toLowerCase();
                const matchesQuery = name.includes(query) || desc.includes(query);
                const matchesFilter = filter === 'All' || item.type === filter;
                return matchesQuery && matchesFilter;
            });

            // Sort by type, then name
            filteredData.sort((a, b) => {
                if (a.type === b.type) return a.name.localeCompare(b.name);
                return a.type.localeCompare(b.type);
            });

            // Render results
            resultsContainer.innerHTML = filteredData.length > 0
                ? filteredData.map(item => `
                    <div class="result">
                        <h3>${highlightSearchTerm(item.name, query)} (${item.type})</h3>
                        <p>${highlightSearchTerm(item.desc, query)}</p>
                        ${item.type === 'Ability' && item.character ? `<p class="character-link">Used by ${highlightSearchTerm(item.character, query)}</p>` : ''}
                    </div>
                `).join('')
                : '<p class="no-results">No results found.</p>';
        }

        // Event listeners for search and filter
        searchInput.addEventListener('input', renderResults);
        filterSelect.addEventListener('change', renderResults);

        // Load data after scripts are available
        window.onload = loadData;
    </script>
</body>
</html>
